#!/usr/bin/env cwl-runner

cwlVersion: v1.0

class: Workflow

inputs:
  - id: workflow_nthreads
    type: int
    default: 4
  - id: workflow_end_mode
    type: string
    default: "PE"
  - id: trimmomatic_java_opts
    type: string
    default: -Xmx4g
  - id: trimmomatic_phred
    type: string
  - id: trimmomatic_input_read1_fastq_file
    type: File
  - id: trimmomatic_input_read2_fastq_file
    type: ['null', File]
  - id: trimmomatic_input_adapters_file
    type: File
  - id: trimmomatic_illuminaclip
    type: string
  - id: trimmomatic_slidingwindow
    type: ['null', string]
    default: null
  - id: trimmomatic_maxinfo
    type: ['null', string]
    default: null
  - id: trimmomatic_leading
    type: ['null', int]
    default: null
  - id: trimmomatic_trailing
    type: ['null', int]
    default: null
  - id: trimmomatic_crop
    type: ['null', int]
    default: null
  - id: trimmomatic_headcrop
    type: ['null', int]
    default: null
  - id: trimmomatic_minlen
    type: ['null', int]
    default: null
  - id: trimmomatic_avgqual
    type: ['null', int]
    default: null
  - id: trimmomatic_tophred33
    type: ['null', boolean]
    default: null
  - id: trimmomatic_tophred64
    type: ['null', boolean]
    default: null
  - id: novoalign_dbname
    type: File
  - id: novoalign_format
    type: string
  - id: novoalign_length
    type: string
  - id: novoalign_output_format
    type: string
  - id: novoalign_readgroup
    type: string
  - id: novoalign_reference_seq
    type: File
  - id: novoalign_output_name
    type: string

outputs:

  - id: output_read1_trimmed_file
    type: File
    outputSource: trimmomatic_tool/output_read1_trimmed_file
  - id: output_read1_trimmed_unpaired_file
    type: ['null', File]
    outputSource: trimmomatic_tool/output_read1_trimmed_unpaired_file
  - id: output_read2_trimmed_paired_file
    type: ['null', File]
    outputSource: trimmomatic_tool/output_read2_trimmed_paired_file
  - id: output_read2_trimmed_unpaired_file
    type: ['null', File]
    outputSource: trimmomatic_tool/output_read2_trimmed_unpaired_file
  - id: output_log_file
    type: ['null', File]
    outputSource: trimmomatic_tool/output_log_file
  - id: output_novoaligned_bam_file
    type: File
    outputSource: novoalign_tool/output_file

steps:

  - id: trimmomatic_tool
    run: ../tools/primary_analysis/trimmomatic.cwl.yaml
    in:
       - id: java_opts
         source: trimmomatic_java_opts
       - id: end_mode
         source: workflow_end_mode
       - id: nthreads
         source: workflow_nthreads
       - id: phred
         source: trimmomatic_phred
       - id: input_read1_fastq_file
         source: trimmomatic_input_read1_fastq_file
       - id: input_read2_fastq_file
         source: trimmomatic_input_read2_fastq_file
       - id: input_adapters_file
         source: trimmomatic_input_adapters_file
       - id: illuminaclip
         source: trimmomatic_illuminaclip
       - id: slidingwindow
         source: trimmomatic_slidingwindow
       - id: maxinfo
         source: trimmomatic_maxinfo
       - id: leading
         source: trimmomatic_leading
       - id: trailing
         source: trimmomatic_trailing
       - id: crop
         source: trimmomatic_crop
       - id: headcrop
         source: trimmomatic_headcrop
       - id: minlen
         source: trimmomatic_minlen
       - id: avgqual
         source: trimmomatic_avgqual
       - id: tophred33
         source: trimmomatic_tophred33
       - id: tophred64
         source: trimmomatic_tophred64

    out:
       - id: output_read1_trimmed_file
       - id: output_read1_trimmed_unpaired_file
       - id: output_read2_trimmed_paired_file
       - id: output_read2_trimmed_unpaired_file
       - id: output_log_file

  - id: novoalign_tool
    run: ../tools/primary_analysis/novoalign.cwl.yaml
    in:
       - id: nthreads
         source: workflow_nthreads
       - id: dbname
         source: novoalign_dbname
       - id: input_read1_fastq_file
         source: trimmomatic_tool/output_read1_trimmed_file
       - id: input_read2_fastq_file
         source: trimmomatic_tool/output_read2_trimmed_paired_file
       - id: format
         source: novoalign_format
       - id: mode
         source: workflow_end_mode
       - id: length
         source: novoalign_length
       - id: output_format
         source: novoalign_output_format
       - id: readgroup
         source: novoalign_readgroup
       - id: reference_seq
         source: novoalign_reference_seq
       - id: output_name
         source: novoalign_output_name

    out:
       - id: output_file
