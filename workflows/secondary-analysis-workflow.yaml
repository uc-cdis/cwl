#!/usr/bin/env cwl-runner

cwlVersion: v1.0

class: Workflow

inputs:

  - id: input_bam_path
    type: File
  - id: validation_stringency
    default: "SILENT"
    type: string
  - id: reference_seq
    type: File
  - id: reference_indel_path
    type: File
  - id: reference_snp_path
    type: File

outputs:

  - id: duplicate_removed_output_bam
    type: File
    outputSource: LLDR_SLDR-tool/duplicate_removed_output_bam
  - id: duplicate_removed_output_metrics
    type: File
    outputSource: LLDR_SLDR-tool/duplicate_removed_output_metrics
  - id: duplicate_removed_output_bai
    type: File
    outputSource: LLDR_SLDR-tool/duplicate_removed_output_bai
  - id: left_aligned_bam
    type: File
    outputSource: LeftAlignIndels/left_aligned_bam
  - id: output_target
    type: File
    outputSource: RealignerTargetCreator/output_target
  - id: output_bqsr_bam
    type: File
    outputSource: IndelRealigner/output_bqsr_bam

steps:

  - id: LLDR_SLDR-tool
    run: ../tools/primary_analysis/LLDR_SLDR.cwl.yaml
    in:
       - id: input_bam_path
         source: input_bam_path
       - id: validation_stringency
         source: validation_stringency

    out:
       - id: duplicate_removed_output_bam
       - id: duplicate_removed_output_metrics
       - id: duplicate_removed_output_bai

  - id: LeftAlignIndels
    run: ../tools/secondary_analysis/LeftAlignIndels.cwl.yaml
    in:
       - id: LeftAlignIndels.input_bam_path
         source: LLDR_SLDR-tool/duplicate_removed_output_bam
       - id: LeftAlignIndels.reference_fasta_path
         source: reference_seq

    out:
       - id: left_aligned_bam


  - id: RealignerTargetCreator
    run: ../tools/secondary_analysis/RealignerTargetCreator.cwl.yaml
    in:
       - id: input_bam_path
         source: LeftAlignIndels/left_aligned_bam
       - id: reference_fasta_path
         source: reference_seq
       - id: reference_indel_path
         source: reference_indel_path
       - id: reference_snp_path
         source: reference_snp_path

    out:
       - id: output_target

  - id: IndelRealigner
    run: ../tools/secondary_analysis/IndelRealigner.cwl.yaml
    in:
       - id: input_bam_path
         source: LeftAlignIndels/left_aligned_bam
       - id: reference_fasta_path
         source: reference_seq
       - id: reference_indel_path
         source: reference_indel_path
       - id: reference_snp_path
         source: reference_snp_path
       - id: target_intervals
         source: RealignerTargetCreator/output_target

    out:
       - id: output_bqsr_bam
