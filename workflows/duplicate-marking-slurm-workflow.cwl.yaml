#!/usr/bin/env cwl-runner

cwlVersion: v1.0

doc: |
    GenoMEL two-steps GATK Mark duplicates Workflow

class: Workflow

requirements:
  - class: SubworkflowFeatureRequirement
  - class: StepInputExpressionRequirement
  - class: InlineJavascriptRequirement

inputs:

##S3_PARAMETERS##
  - id: aws_config
    type: File
    default: "/home/ubuntu/.aws/config"
    doc: AWS S3 configuration file. Usually located at ~/.aws/config
  - id: aws_shared_credentials
    type: File
    default: "/home/ubuntu/.aws/credentials"
    doc: AWS S3 credentials file. Usually located at ~/.aws/credentials
  - id: s3_profile
    type: string
    default: "genomel-cleversafe"
    doc: S3 profile associated to your bucket.
  - id: s3_endpoint
    default: "https://atwood-accessors.osdc.io"
    type: string
    doc: S3 endpoint associated to your bucket.
  - id: bam_s3uri
    type: string
    doc: S3 path to BAM file for input
  - id: s3dir
    type: string
    doc: Remote bucket in S3 to upload file.

###GENERAL_WORKFLOW_INPUTS###
  - id: markduplicate_java_opts
    type: string
    default: "-Xmx16g"
    doc: JVM arguments for trimmomatic (e.g. 512m or 4g). 16g by default.
  - id: input_bam_path
    type: File
    doc: Input bam file path.
  - id: reference_seq
    type: File
    doc: Reference fasta file, with .dict and .fai.
  - id: lldr_validation_stringency
    type: string
    default: "LENIENT"
    doc: Validation stringency per lane (LLDR). LENIENT by default.  
  - id: sldr_validation_stringency
    type: string
    default: "SILENT"
    doc: Validation stringency per sample (SLDR). SILENT by default.

outputs:

  - id: duplicate_removed_output_bam
    type: File
    outputSource: mark-duplicate-workflow/duplicate_removed_output_bam
    secondaryFiles:
      - '^.bai'

  - id: duplicate_removed_output_metrics
    type: File
    outputSource: mark-duplicate-workflow/duplicate_removed_output_metrics

steps:

  ###UPDATE_TABLES_SUBWORKFLOW###

  ###S3_DOWNLOAD_SUBWORKFLOW###
  - id: get_novoalign_bam
    run: ../tools/s3/aws_s3_get.cwl
    in:
       - id: aws_config
         source: aws_config
       - id: aws_shared_credentials
         source: aws_shared_credentials
       - id: s3uri
         source: bam_s3uri
       - id: s3_profile
         source: s3_profile
       - id: s3_endpoint
         source: s3_endpoint
    out:
       - id: output

  ###MARK_DUPLICATE_SUBWORKFLOW###
  - id: mark-duplicate-workflow
    run: ./duplicate-marking-workflow.cwl.yaml
    in:
       - id: markduplicate_java_opts
         source: markduplicate_java_opts
       - id: input_bam_path
         source: get_novoalign_bam/output
       - id: reference_seq
         source: reference_seq
       - id: lldr_validation_stringency
         source: lldr_validation_stringency
       - id: sldr_validation_stringency
         source: sldr_validation_stringency

    out:
       - id: duplicate_removed_output_bam
       - id: duplicate_removed_output_metrics

  ###UPDATE_TABLES_SUBWORKFLOW###

  ###S3_UPLOAD_WORKFLOW###
  - id: put_bam_s3
    run: ../tools/s3/aws_s3_put.cwl
    in:
       - id: aws_config
         source: aws_config
       - id: aws_shared_credentials
         source: aws_shared_credentials
       - id: input
         source: mark-duplicate-workflow/duplicate_removed_output_bam
       - id: s3uri
         source: s3dir
         valueFrom: $(self + inputs.uuid + "/")
       - id: s3_profile
         source: s3_profile
       - id: s3_endpoint
         source: s3_endpoint
    out:
       - id: output

  - id: put_bai_s3
    run: ../tools/s3/aws_s3_put.cwl
    in:
       - id: aws_config
         source: aws_config
       - id: aws_shared_credentials
         source: aws_shared_credentials
       - id: input
         source: mark-duplicate-workflow/duplicate_removed_output_bam
         valueFrom: $(self.secondaryFiles[0])
       - id: s3uri
         source: s3dir
         valueFrom: $(self + inputs.uuid + "/")
       - id: s3_profile
         source: s3_profile
       - id: s3_endpoint
         source: s3_endpoint
    out:
       - id: output

  - id: put_metrics_s3
    run: ../tools/s3/aws_s3_put.cwl
    in:
       - id: aws_config
         source: aws_config
       - id: aws_shared_credentials
         source: aws_shared_credentials
       - id: input
         source: mark-duplicate-workflow/duplicate_removed_output_metrics
       - id: s3uri
         source: s3dir
         valueFrom: $(self + inputs.uuid + "/")
       - id: s3_profile
         source: s3_profile
       - id: s3_endpoint
         source: s3_endpoint
    out:
       - id: output