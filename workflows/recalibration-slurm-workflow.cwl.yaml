#!/usr/bin/env cwl-runner

cwlVersion: v1.0

class: Workflow

requirements:
  - class: SubworkflowFeatureRequirement
  - class: StepInputExpressionRequirement
  - class: InlineJavascriptRequirement

inputs:

##S3_PARAMETERS##
  - id: aws_config
    type: File
    default: "/home/ubuntu/.aws/config"
    doc: AWS S3 configuration file. Usually located at ~/.aws/config
  - id: aws_shared_credentials
    type: File
    default: "/home/ubuntu/.aws/credentials"
    doc: AWS S3 credentials file. Usually located at ~/.aws/credentials
  - id: s3_profile
    type: string
    default: "genomel-cleversafe"
    doc: S3 profile associated to your bucket.
  - id: s3_endpoint
    default: "https://atwood-accessors.osdc.io"
    type: string
    doc: S3 endpoint associated to your bucket.
  - id: bam_s3uri
    type: string
    doc: S3 path to BAM file for input
  - id: s3dir
    type: string
    doc: Remote bucket in S3 to upload file.

###GENERAL_WORKFLOW_INPUTS###
  - id: java_opts
    type: string
    default: "-Xmx8g"
    doc: JVM arguments should be a quoted, space separated list (e.g. -Xmx8g -Xmx16g -Xms128m -Xmx512m)
  - id: reference_seq
    type: File
    doc: Reference fasta file, with .dict and .fai.
  - id: reference_indel_path
    type: File
    doc: INDEL reference file
  - id: reference_snp_path
    type: File
    doc: SNP reference file

outputs:

  - id: output_realigned_bam
    type: File
    outputSource: recalibration-workflow/output_realigned_bam

steps:

  ###UPDATE_TABLES_SUBWORKFLOW###

  ###S3_DOWNLOAD_SUBWORKFLOW###
  - id: get_markdup_bam
    run: ../tools/s3/aws_s3_get.cwl
    in:
       - id: aws_config
         source: aws_config
       - id: aws_shared_credentials
         source: aws_shared_credentials
       - id: s3uri
         source: bam_s3uri
       - id: s3_profile
         source: s3_profile
       - id: s3_endpoint
         source: s3_endpoint
    out:
       - id: output

  - id: get_markdup_bai
    run: ../tools/s3/aws_s3_get.cwl
    in:
       - id: aws_config
         source: aws_config
       - id: aws_shared_credentials
         source: aws_shared_credentials
       - id: s3uri
         source: bam_s3uri
         valueFrom: ${inputs.bam_s3uri.slice(0,-4) + ".bai"}
       - id: s3_profile
         source: s3_profile
       - id: s3_endpoint
         source: s3_endpoint
    out:
       - id: output

  ###RECALIBRATION_SUBWORKFLOW###
  - id: recalibration-workflow
    run: ./recalibration-workflow.cwl.yaml
    in:
       - id: java_opts
         source: java_opts
       - id: reference_seq
         source: reference_seq
       - id: input_bam_path
         source: get_markdup_bam/output
       - id: reference_indel_path
         source: reference_indel_path
       - id: reference_snp_path
         source: reference_snp_path

    out:
       - id: left_aligned_bam
       - id: output_target
       - id: output_realigned_bam

  ###UPDATE_TABLES_SUBWORKFLOW###

  ###S3_UPLOAD_WORKFLOW###
  - id: put_bam_s3
    run: ../tools/s3/aws_s3_put.cwl
    in:
       - id: aws_config
         source: aws_config
       - id: aws_shared_credentials
         source: aws_shared_credentials
       - id: input
         source: recalibration-workflow/output_realigned_bam
       - id: s3uri
         source: s3dir
         valueFrom: $(self + inputs.uuid + "/")
       - id: s3_profile
         source: s3_profile
       - id: s3_endpoint
         source: s3_endpoint
    out:
       - id: output

  - id: put_bai_s3
    run: ../tools/s3/aws_s3_put.cwl
    in:
       - id: aws_config
         source: aws_config
       - id: aws_shared_credentials
         source: aws_shared_credentials
       - id: input
         source: recalibration-workflow/output_realigned_bam
         valueFrom: $(self.secondaryFiles[0])
       - id: s3uri
         source: s3dir
         valueFrom: $(self + inputs.uuid + "/")
       - id: s3_profile
         source: s3_profile
       - id: s3_endpoint
         source: s3_endpoint
    out:
       - id: output