#!/usr/bin/env cwl-runner

cwlVersion: v1.0

class: Workflow

requirements:
  - class: SubworkflowFeatureRequirement

inputs:
  - id: workflow_nthreads
    type: int
    default: 4
  - id: workflow_end_mode
    type: string
    default: "PE"
  - id: trimmomatic_java_opts
    type: string
    default: 4g
  - id: trimmomatic_phred
    type: string
  - id: trimmomatic_input_read1_fastq_file
    type: File
  - id: trimmomatic_input_read2_fastq_file
    type: ['null', File]
  - id: trimmomatic_input_adapters_file
    type: File
  - id: trimmomatic_illuminaclip
    type: string
  - id: trimmomatic_slidingwindow
    type: ['null', string]
    default: null
  - id: trimmomatic_maxinfo
    type: ['null', string]
    default: null
  - id: trimmomatic_leading
    type: ['null', int]
    default: null
  - id: trimmomatic_trailing
    type: ['null', int]
    default: null
  - id: trimmomatic_crop
    type: ['null', int]
    default: null
  - id: trimmomatic_headcrop
    type: ['null', int]
    default: null
  - id: trimmomatic_minlen
    type: ['null', int]
    default: null
  - id: trimmomatic_avgqual
    type: ['null', int]
    default: null
  - id: trimmomatic_tophred33
    type: ['null', boolean]
    default: null
  - id: trimmomatic_tophred64
    type: ['null', boolean]
    default: null
  - id: novoalign_dbname
    type: File
  - id: novoalign_format
    type: string
  - id: novoalign_length
    type: string
  - id: novoalign_output_format
    type: string
  - id: novoalign_readgroup
    type: string
  - id: reference_seq
    type: File
  - id: novoalign_output_name
    type: string


outputs:

  - id: duplicate_removed_output_bam
    type: File
    outputSource: mark_duplicates_workflow/duplicate_removed_output_bam
  - id: duplicate_removed_output_metrics
    type: File
    outputSource: mark_duplicates_workflow/duplicate_removed_output_metrics
  - id: duplicate_removed_output_bai
    type: File
    outputSource: mark_duplicates_workflow/duplicate_removed_output_bai


steps:

  - id: alignment_workflow
    run: alignment-workflow.cwl.yaml
    in:
       - id: trimmomatic_java_opts
         source: trimmomatic_java_opts
       - id: workflow_end_mode
         source: workflow_end_mode
       - id: workflow_nthreads
         source: workflow_nthreads
       - id: trimmomatic_phred
         source: trimmomatic_phred
       - id: trimmomatic_input_read1_fastq_file
         source: trimmomatic_input_read1_fastq_file
       - id: trimmomatic_input_read2_fastq_file
         source: trimmomatic_input_read2_fastq_file
       - id: trimmomatic_input_adapters_file
         source: trimmomatic_input_adapters_file
       - id: trimmomatic_illuminaclip
         source: trimmomatic_illuminaclip
       - id: trimmomatic_slidingwindow
         source: trimmomatic_slidingwindow
       - id: trimmomatic_maxinfo
         source: trimmomatic_maxinfo
       - id: trimmomatic_leading
         source: trimmomatic_leading
       - id: trimmomatic_trailing
         source: trimmomatic_trailing
       - id: trimmomatic_crop
         source: trimmomatic_crop
       - id: trimmomatic_headcrop
         source: trimmomatic_headcrop
       - id: trimmomatic_minlen
         source: trimmomatic_minlen
       - id: trimmomatic_avgqual
         source: trimmomatic_avgqual
       - id: trimmomatic_tophred33
         source: trimmomatic_tophred33
       - id: trimmomatic_tophred64
         source: trimmomatic_tophred64
       - id: novoalign_dbname
         source: novoalign_dbname
       - id: novoalign_format
         source: novoalign_format
       - id: novoalign_length
         source: novoalign_length
       - id: novoalign_output_format
         source: novoalign_output_format
       - id: novoalign_readgroup
         source: novoalign_readgroup
       - id: novoalign_reference_seq
         source: reference_seq
       - id: novoalign_output_name
         source: novoalign_output_name

    out:
       - id: output_read1_trimmed_file
       - id: output_read1_trimmed_unpaired_file
       - id: output_read2_trimmed_paired_file
       - id: output_read2_trimmed_unpaired_file
       - id: output_log_file
       - id: output_novoaligned_bam_file


  - id: mark_duplicates_workflow
    run: duplicate-marking-workflow.cwl.yaml
    in:
       - id: input_bam_path
         source: alignment_workflow/output_novoaligned_bam_file
       - id: reference_seq
         source: reference_seq

    out:
       - id: output_sorted_bam_file
       - id: output_lldr_bam_file
       - id: output_lldr_bai_file
       - id: output_lldr_metrics_file
       - id: paired_output_file
       - id: nophix_output_file
       - id: duplicate_removed_output_bam
       - id: duplicate_removed_output_metrics
       - id: duplicate_removed_output_bai


