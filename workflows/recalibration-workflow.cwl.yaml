#!/usr/bin/env cwl-runner

cwlVersion: v1.0

doc: |
    GenoMEL Recalibration Workflow

class: Workflow

requirements:
  - class: SubworkflowFeatureRequirement
  - class: StepInputExpressionRequirement
  - class: InlineJavascriptRequirement
  - class: MultipleInputFeatureRequirement

inputs:

###GENERAL_WORKFLOW_INPUTS###
  - id: java_opts
    type: string
    default: "-Xmx8g"
    doc: JVM arguments should be a quoted, space separated list (e.g. -Xmx8g -Xmx16g -Xms128m -Xmx512m)
  - id: reference_seq
    type: File
    doc: Reference fasta file, with .dict and .fai.
  - id: input_bam_path
    type: File
    doc: Input bam file path.
  - id: reference_indel_path
    type: File
    doc: INDEL reference file
  - id: reference_snp_path
    type: File
    doc: SNP reference file

outputs:

  - id: left_aligned_bam
    type: File
    outputSource: LeftAlignIndels/left_aligned_bam
  - id: output_target
    type: File
    outputSource: RealignerTargetCreator/output_target
  - id: output_realigned_bam
    type: File
    outputSource: IndelRealigner/output_realigned_bam

steps:

  - id: SamtoolsIndex
    run: ../tools/sorting/samtoolsIndex.cwl.yaml
    in:
       - id: input_bam_path
         source: input_bam_path

    out:
       - id: output_bai

  - id: root_bam
    run: ../tools/sorting/root_bam.cwl
    in:
       - id: bam
         source: input_bam_path
       - id: bam_index
         source: SamtoolsIndex/output_bai
    out:
       - id: output

  - id: LeftAlignIndels
    run: ../tools/secondary_analysis/LeftAlignIndels.cwl.yaml
    in:
       - id: java_opts
         source: java_opts
       - id: input_bam_path
         source: root_bam/output
       - id: reference_fasta_path
         source: reference_seq

    out:
       - id: left_aligned_bam

  - id: RealignerTargetCreator
    run: ../tools/secondary_analysis/RealignerTargetCreator.cwl.yaml
    in:
       - id: java_opts
         source: java_opts
       - id: input_bam_path
         source: LeftAlignIndels/left_aligned_bam
       - id: reference_fasta_path
         source: reference_seq
       - id: reference_indel_path
         source: reference_indel_path
       - id: reference_snp_path
         source: reference_snp_path

    out:
       - id: output_target

  - id: IndelRealigner
    run: ../tools/secondary_analysis/IndelRealigner.cwl.yaml
    in:
       - id: java_opts
         source: java_opts
       - id: input_bam_path
         source: LeftAlignIndels/left_aligned_bam
       - id: reference_fasta_path
         source: reference_seq
       - id: reference_indel_path
         source: reference_indel_path
       - id: reference_snp_path
         source: reference_snp_path
       - id: target_intervals
         source: RealignerTargetCreator/output_target

    out:
       - id: output_realigned_bam
