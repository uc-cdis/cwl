#!/usr/bin/env cwl-runner

cwlVersion: v1.0

doc: |
    GenoMEL two-steps GATK Mark duplicates Workflow

class: Workflow

inputs:

###GENERAL_WORKFLOW_INPUTS###
  - id: markduplicate_java_opts
    type: string
    default: "-Xmx16g"
    doc: JVM arguments for trimmomatic (e.g. 512m or 4g). 16g by default.
  - id: input_bam_path
    type: File
    doc: Input bam file path.
  - id: reference_seq
    type: File
    doc: Reference fasta file, with .dict and .fai.
  - id: lldr_validation_stringency
    type: string
    default: "LENIENT"
    doc: Validation stringency per lane (LLDR). LENIENT by default.  
  - id: sldr_validation_stringency
    type: string
    default: "SILENT"
    doc: Validation stringency per sample (SLDR). SILENT by default.

outputs:

  - id: duplicate_removed_output_bam
    type: File
    outputSource: sldr-markduplicates-tool/duplicate_removed_output_bam
    secondaryFiles:
      - '^.bai'

  - id: duplicate_removed_output_metrics
    type: File
    outputSource: sldr-markduplicates-tool/duplicate_removed_output_metrics

steps:

  - id: samtools-sort
    run: ../tools/sorting/samtoolsSort.cwl.yaml
    in:
       - id: input_bam_path
         source: input_bam_path

    out:
       - id: sorted_output_bam


  - id: lldr-markduplicates-tool
    run: ../tools/primary_analysis/LLDR_SLDR.cwl.yaml
    in:
       - id: java_opts
         source: markduplicate_java_opts
       - id: input_bam_path
         source: samtools-sort/sorted_output_bam
       - id: validation_stringency
         source: lldr_validation_stringency

    out:
       - id: duplicate_removed_output_bam
       - id: duplicate_removed_output_metrics

  - id: remove-unpaired
    run: ../tools/sorting/RemoveUnpaired.cwl.yaml
    in:
       - id: input_bam_path
         source: lldr-markduplicates-tool/duplicate_removed_output_bam

    out:
       - id: paired_output_bam

  - id: remove-phix
    run: ../tools/sorting/RemovePhiX.cwl.yaml
    in:
       - id: input_bam_path
         source: remove-unpaired/paired_output_bam

    out:
       - id: fixed_output_bam

  - id: sldr-markduplicates-tool
    run: ../tools/primary_analysis/LLDR_SLDR.cwl.yaml
    in:
       - id: java_opts
         source: markduplicate_java_opts
       - id: input_bam_path
         source: remove-phix/fixed_output_bam
       - id: validation_stringency
         source: sldr_validation_stringency

    out:
       - id: duplicate_removed_output_bam
       - id: duplicate_removed_output_metrics
